<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arduino connectivity test with JavaScript</title>

    <!-- Bootstrap -->
    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"
    ></script>
  </head>

  <body>
    <div class="container">
      <h1>Estándares de programación</h1>
      <div class="row">
        <div class="col-md-12">
          <div id="app" class="conteiner">
            <div class="sidebar col-md-4">
              <section class="cameras">
                <h2>Cameras</h2>
                <ul>
                  <li v-if="cameras.length === 0" class="empty">
                    No cameras found
                  </li>
                  <li v-for="camera in cameras">
                    <span
                      v-if="camera.id == activeCameraId"
                      :title="formatName(camera.name)"
                      class="active"
                      >{{ formatName(camera.name) }}</span
                    >
                    <span
                      v-if="camera.id != activeCameraId"
                      :title="formatName(camera.name)"
                    >
                      <a @click.stop="selectCamera(camera)">{{
                        formatName(camera.name)
                      }}</a>
                    </span>
                  </li>
                </ul>
              </section>
              <section class="scans">
                <h2>Scans</h2>
                <ul v-if="scans.length === 0">
                  <li class="empty">No scans yet</li>
                </ul>
                <transition-group name="scans" tag="ul">
                  <li
                    v-for="scan in scans"
                    :key="scan.date"
                    :title="scan.content"
                  >
                    {{ scan.content }}
                  </li>
                </transition-group>
              </section>
            </div>
            <div class="preview-container col-md-8">
              <video id="preview"></video>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      var socket = io.connect('http://localhost');

      socket.on('news', function(data) {
        console.log(data);
      });

      var app = new Vue({
        el: '#app',
        data: {
          scanner: null,
          activeCameraId: null,
          cameras: [],
          scans: []
        },
        mounted: function() {
          var self = this;
          self.scanner = new Instascan.Scanner({
            video: document.getElementById('preview'),
            scanPeriod: 5
          });
          self.scanner.addListener('scan', function(content, image) {
            self.scans.unshift({ date: +Date.now(), content: content });
            // Se dispara evento para que el servo se ponga en 190°

            socket.emit('servo', { pos: 190 });
            setTimeout(() => {
              socket.emit('servo', { pos: 90 });
            }, 10000);
          });
          Instascan.Camera.getCameras()
            .then(function(cameras) {
              self.cameras = cameras;
              if (cameras.length > 0) {
                self.activeCameraId = cameras[0].id;
                self.scanner.start(cameras[0]);
              } else {
                console.error('No cameras found.');
              }
            })
            .catch(function(e) {
              console.error(e);
            });

          // Para servo

          // Evento que se dispara para poner el led en 2 segundos
          socket.emit('led', { delay: 2000 });

          // Evento que se dispara que el motor servo, inicia en 90°
          socket.emit('servo', { pos: 90 });
        },
        methods: {
          formatName: function(name) {
            return name || '(unknown)';
          },
          selectCamera: function(camera) {
            this.activeCameraId = camera.id;
            this.scanner.start(camera);
          }
        }
      });
    </script>
  </body>
</html>
